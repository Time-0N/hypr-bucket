name: Publish to AUR

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish (example: v1.1.0)"
        required: true

permissions:
  contents: read

concurrency:
  group: aur-publish
  cancel-in-progress: true

jobs:
  aur:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Select tag + compute version
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            RAW="${{ github.event.inputs.tag }}"
            TAG="$(printf '%s' "$RAW" | sed -E 's/^[[:space:]]*tag[[:space:]]*=[[:space:]]*//; s/^[[:space:]]+|[[:space:]]+$//g')"
            git fetch --tags --force
            git checkout -f "refs/tags/$TAG"
          else
            TAG="${GITHUB_REF_NAME}"
          fi

          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update PKGBUILD pkgver/pkgrel (repo root)
        shell: bash
        run: |
          set -euo pipefail
          test -f PKGBUILD
          sed -i "s/^pkgver=.*/pkgver=${{ steps.ver.outputs.version }}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

      - name: "Debug: show effective PKGBUILD fields"
        shell: bash
        run: |
          set -euo pipefail
          echo "Checked out:"
          git describe --tags --always --dirty || true
          grep -nE '^(pkgver|pkgrel|source)=' PKGBUILD

      - name: Publish AUR package
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: hypr-bucket
          pkgbuild: ./PKGBUILD
          updpkgsums: true
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ steps.ver.outputs.tag }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
